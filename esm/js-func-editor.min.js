function*t(t){const s=t.ownerDocument.getSelection(),r=function(t,n){if(!n||!n.intersectsNode(t))return;const s=t.ownerDocument.createRange();if(s.selectNode(t),-1===n.compareBoundaryPoints(Range.START_TO_START,s))return;if(1===n.compareBoundaryPoints(Range.END_TO_END,s))return;return{start:e(t,n.startContainer,n.startOffset),end:e(t,n.endContainer,n.endOffset)}}(t,1===s.rangeCount&&s.getRangeAt(0));yield r;const i=function(t,e){if(!e)return;const s=n(t,e.start),r=n(t,e.end);if(s&&r){const e=t.ownerDocument.createRange();return e.setStart(s[0],s[1]),e.setEnd(r[0],r[1]),e}}(t,r);i&&(s.removeAllRanges(),s.addRange(i))}function e(t,e,n){for(;e!==t;){const t=e;e=e.parentNode;for(const s of e.childNodes){if(s===t)break;n+=s.textContent.length}}return n}function n(t,e){if(e>t.textContent.length)return;let n=t.childNodes[0];for(;n;){const t=n.textContent.length;if(t<e)e-=t,n=n.nextSibling;else{if(3===n.nodeType)return[n,e];n=n.childNodes[0]}}}class s{constructor(t,e=null){this._duringUpdate=!1,this._stack=[e],this._ctrl=document.createElement("div"),this._ctrl.setAttribute("aria-hidden","true"),this._ctrl.style.opacity=0,this._ctrl.style.position="fixed",this._ctrl.style.top="-1000px",this._ctrl.style.pointerEvents="none",this._ctrl.tabIndex=-1,this._ctrl.contentEditable=!0,this._ctrl.textContent="0",this._ctrl.style.visibility="hidden",this._ctrl.addEventListener("focus",(t=>{window.setTimeout((()=>{this._ctrl.blur()}),0)})),this._ctrl.addEventListener("input",(e=>{this._duringUpdate||t(this.data);const n=window.getSelection();n.containsNode(this._ctrl,!0)&&n.removeAllRanges()}))}get _depth(){return+this._ctrl.textContent||0}get data(){return this._stack[this._depth]}push(t,e){this._ctrl.parentNode||(e||document.body).appendChild(this._ctrl);const n=this._depth+1;this._stack.splice(n,this._stack.length-n,t);const s=document.activeElement;try{this._duringUpdate=!0,this._ctrl.style.visibility=null,this._ctrl.focus(),document.execCommand("selectAll"),document.execCommand("insertText",!1,n)}finally{this._duringUpdate=!1,this._ctrl.style.visibility="hidden"}s&&s.focus()}}function r(e,n,r,l){!function(t,e){const n={...o,...e.attrs||{}};for(const e in n)t.setAttribute(e,n[e]);Object.assign(t.style,{...a,...e.style||{}})}(n,l),function(e,n,r){let i=new s(o,r);function o(t){const n=i;i=null;try{e._restore_state(t)}finally{i=n}}const a=function(t){let e,n=[];return s;function s(t){t&&n.push(t),void 0===e&&0!==n.length&&(e=requestAnimationFrame(r))}async function r(){let r=n;n=[];for(let e of r)await e.call(t);e=void 0,s()}}(e);let l=null;Object.assign(e,{*with_selection(){for(const e of t(n))yield},dirty(){a(e._refresh_selection),l=e._event_from_state(r),a(e.refresh_code)},_refresh_selection(){for(const t of e.with_selection())e.src_code=e.src_code+""},_emit_code_change(){c(e,l,"")},_emit_src_code(t,n,s=["lang","src_code"]){(function(t,e,n){for(const s of n)if(t[s]!==e[s])return!1;return!0})(n,r,s)||(r=n,null!==i&&i.push(e._save_state(n),t),l=e._event_from_state(r),a(e.refresh_code),c(e,l,":input"))}}),a(e.dirty),a(e._emit_code_change)}(e,n,r);const d=l.events||i,_=function(t,...e){const{table:n,attrs:s}=t;return t=>{const r=[`evt:${t.type}`,...s.map((e=>`${e}:${t[e]}`)).filter(Boolean)];for(let s=r.length;s>0;s--){const i=n[r.slice(0,s)];if(i)return i(t,...e)}}}(d,e,l);for(const t of d.keys)n.addEventListener(t,_);return()=>{for(const t of d.keys)n.removeEventListener(t,_)}}const i=Object.freeze({keys:Object.freeze(["keydown","keyup","paste","input","blur"]),attrs:Object.freeze(["key"]),table:Object.freeze({...function(){const t=new WeakSet;return{"evt:blur"(e,n){t.has(n)?e.preventDefault():n._emit_code_change()},async"evt:input"(e,n){if(!t.has(n)){t.add(n),await null;try{const t=n.src_code;for(const e of n.with_selection())document.execCommand("undo",!1),n.raw_src_code=t,n.dirty()}finally{t.delete(n)}}}}}(),"evt:keydown,key:Tab"(t,e,n){t.preventDefault(),document.execCommand("insertText",!1,n.tabs||"    ")},"evt:paste"(t,e){t.preventDefault();const n=t.clipboardData.getData("text/plain");n&&(document.execCommand("insertText",!1,n),e.dirty())}})});function c(t,e,n){if(e)return t.dispatchEvent(new CustomEvent("src_code"+n,{detail:e,bubbles:!0}))}const o={contentEditable:!0,spellcheck:!1},a={outline:"none",overflowWrap:"break-word",overflowY:"auto",resize:"vertical",whiteSpace:"pre-wrap"};class l extends HTMLElement{static with_options(t={}){return class extends(this){_dom_connect(e,n){r(this,e,n,t)}}}static define_with(t,e){let n=class extends(this){};return Object.assign(n.prototype,e),customElements.define(t,n),n}connectedCallback(){const t=this.textContent.replace(/^\s*\r?\n/,"");this.textContent="";const e={src_code:t,lang:this.lang},n=this._el_code=this._init_code_dom();this._dom_connect(n,e),this.src_code=t}_dom_connect(t,e){r(this,t,e,{})}disconnectedCallback(){this._dom_disconnect&&this._dom_disconnect()}_init_code_dom(t){let e=this.ownerDocument;const n=e.createElement("code"),s=e.createElement("pre");return s.appendChild(n),this.appendChild(s),t&&(s.className=t),n}static get observedAttributes(){return["lang","mode"]}attributeChangedCallback(){this.dirty()}dirty(){}get lang(){return this.getAttribute("lang")||this.default_lang||"js"}set lang(t){this.setAttribute("lang",t)}get raw_src_code(){return this._el_code.textContent}set raw_src_code(t){const{_el_code:e,lang:n}=this;this.render_code(n,t,e),this._emit_src_code(this,{src_code:t,lang:n})}get src_code(){return this._el_code.textContent}set src_code(t){this.raw_src_code=t,this.highlight_src(t,this._el_code)}_save_state(t){return t}_restore_state({lang:t,src_code:e}){this.lang=t,this.src_code=e}_event_from_state(t){return{...t}}render_code(t,e,n,s){if(n.innerText="",n.textContent=e,t){const e=`language-${t}`;n.classList.add(e),n.parentNode.classList.add(e)}return s&&this.highlight_src(e,n),n}highlight_src(t,e){globalThis.Prism&&Prism.highlightElement(e)}}class d{constructor(t=(t=>t)){this.transpile=t}compile_func(t,e){let n={};try{n.js=this.transpile(t)}catch(t){return n.err=t,n}try{let t=new Function(`return (${this.as_func_src(n.js,e)})`);n.fn=t()}catch(t){return n.err=t,n}return n}as_func_src(t,{func:e,name:n,args:s}){if(!e.match(/\bfunction\b/)){const[t,n,s]=e.match(/^([^\*]*)(\*.*)?$/);e=`${n||""} function ${s||""}`}return`${e.trim()} ${n||""}(${s||""}){\n${t}\n}`}}const _=class extends l{constructor(){super(),this.compiler=this.createCompiler(),this.dyn_proto=this._bindDynProto(this,this.compiler)}createCompiler(){return new d(this.transpile)}_bindDynProto(t,e){return{compiler:e,lazy(){let n=t.as_compile_ctx(t),s=e.compile_func(this.src_code,n);return Object.assign(this,s),this.lazy=t=>this,this},get dyn_fn(){return this.lazy().fn},get dyn_js(){return this.lazy().js}}}static get observedAttributes(){return super.observedAttributes.concat(["name","func","args"])}get name(){return this.getAttribute("name")||this.default_name||""}set name(t){this.setAttribute("name",t)}get func(){return this.getAttribute("func")||this.default_func||""}set func(t){this.setAttribute("func",t)}get args(){return this.getAttribute("args")||this.default_args||""}set args(t){this.setAttribute("args",t)}get mode(){return this.getAttribute("mode")}set mode(t){return this.setAttribute("mode",t)}as_compile_ctx({name:t,func:e,args:n}){return{name:t,func:e,args:n}}get dyn_fn(){return this.dyn?.dyn_fn}get dyn_js(){return this.dyn?.dyn_js}_event_from_state(t){return this.dyn={__proto__:this.dyn_proto,...t}}refresh_code(){let t=this.mode;if(!t)return void(this._el_dual&&=void this._el_dual.parentNode.remove());this._el_dual||=this._init_code_dom(t);let e=this.dyn.lazy(),n=this.hasAttribute("debug")?""+e.fn:e.js;null!=e.err&&(n=`// ${e.err}\n\n${n}`),this.render_code("js",n,this._el_dual,!0)}}.define_with("js-func-editor",{default_lang:"js"});export{_ as JSFuncCodeEditor,_ as default};
//# sourceMappingURL=js-func-editor.min.js.map
